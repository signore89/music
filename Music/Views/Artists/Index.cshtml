@using Microsoft.AspNetCore.Identity
@using Music.ViewsModels
@model IEnumerable<Music.Models.Artist>

@{
    ViewData["Title"] = "Исполнители песен";
    var pager = new PageViewModel();
    var pageNo = 0;
    if (ViewBag.Pager != null)
    {
        pager = ViewBag.Pager;
        pageNo = pager.CurrentPage;
    }
}

@if (User.IsInRole("Admin"))
{
    <p>
        <a asp-action="Create"
           class="btn btn-primary">
            <i class="bi bi-pencil"></i> Добавить артиста
        </a>
    </p>
}

<div class="container py-5">
        <h1 class="text-center mb-5">Исполнители</h1>

        <div class="row">
            @foreach (var artist in Model) 
            {
        
                <div class="card artist-card mb-4" style="width: 18rem;">
                       <!-- Изображение артиста -->
                       <img src="@Url.Content(artist.UrlImg)"
                        class="card-img-top"
                        alt="@artist.Name"
                        asp-append-version="true">

                        <div class="card-body">
                        <!-- Имя артиста -->
                            <h5 class="card-title">@artist.Name</h5>

                        <!-- Кнопки действий -->
                            <div class="d-flex flex-wrap gap-2">

                                            <!-- Альбомы -->
                                            <a asp-controller="Albums" asp-action="Index" asp-route-idArtist="@artist.Id"
                                               class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-collection"></i> Альбомы
                                            </a>

                                            @* <!-- Песни -->
                                            <a asp-controller="Song" asp-action="SoundLibrary" asp-route-artistId="@artist.Id"
                                               class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-music-note-list"></i> Песни
                                            </a> *@
                        @if (User.IsInRole("Admin"))
                        {
                            <!-- Изменить -->
                            <a asp-action="Edit" asp-route-id="@artist.Id"
                               class="btn btn-outline-warning btn-sm">
                                <i class="bi bi-pencil"></i> Изменить
                            </a>

                            <!-- Удалить -->
                            <a asp-action="Delete" asp-route-id="@artist.Id"
                               class="btn btn-outline-danger">
                                <i class="bi bi-pencil"></i> Удалить
                            </a>
                        }
                        else if (User.IsInRole("User"))
                        {
                            <button class="favorite-btn @((ViewBag.UserFavoritesArtists as ICollection<int>).Contains(artist.Id) ? "active" : "")"
                                   
                                data-id="@artist.Id">
                                @if ((ViewBag.UserFavoritesArtists as ICollection<int>).Contains(artist.Id))
                                {
                                    <span>★ В избранном</span>
                                }
                                else
                                {
                                    <span>☆ Добавить в избранное</span>
                                }
                            </button> 
                        }

                            <!-- Детали -->
                                <a asp-action="Details" asp-route-id="@artist.Id"
                                class="btn btn-outline-warning btn-sm">
                                <i class="bi bi-pencil"></i> Рассмотреть
                                </a>
                            </div>
                        </div>
                </div>

           }
        </div>
</div>

<div class="container">
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            @if (pager.TotalPages > 0)
            {
                <li class="page-item @(pager.CurrentPage == 1 ? "disabled" : "")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-page="@(pager.CurrentPage - 1)">Предыдущая</a>
                </li>
                    @for (var pge = pager.StartPage; pge <= pager.EndPage; pge++)
                    {
                        <li class="page-item @(pge == pager.CurrentPage ? "active" : "")">
                            <a class="page-link" asp-controller="Artists" asp-action="Index" asp-route-page="@pge">@pge</a>
                        </li>
                    }
                    <li class="page-item @(pager.CurrentPage == pager.TotalPages ? "disabled" : "")">
                        <a class="page-link"
                           asp-action="Index"
                           asp-route-page="@(pager.CurrentPage + 1)">Следующая</a>
                    </li>
            }
        </ul>
    </nav>
</div>

@section Scripts 
{
    <script>
        $(document).ready(function() {
            // После загрузки DOM
            $('.favorite-btn').click(function() {
                // При клике на кнопку с классом favorite-btn
                var btn = $(this);
                var artistId = btn.data('id');// Получаем ID артиста из data-атрибута

                if (btn.hasClass('active')) {
                    // Если кнопка активна - УДАЛЯЕМ из избранного
                    $.post('@Url.Action("RemoveArtist", "Favorites")', { artistId: artistId }, function() {
                        // После успешного удаления
                        btn.removeClass('active');
                        btn.html('<span>☆ Добавить в избранное</span>');
                    });
                } else {
                    // Если кнопка не активна - ДОБАВЛЯЕМ в избранное
                    $.post('@Url.Action("AddArtist", "Favorites")', { artistId: artistId }, function() {
                        // После успешного добавления
                        btn.addClass('active');
                        btn.html('<span>★ В избранном</span>');
                    });
                }
            });
        });
    </script>
}

